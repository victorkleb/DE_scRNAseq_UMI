

#########################################################################################
#########################################################################################
#                                                                                       #    
#  start program  randomized_MLE_cell_clusters_group_id.py                              # 
#                                                                                       #   
#########################################################################################
#
#  invoke FUNCTION   MLE_cell_cluster_models   
#
#########################################################################################

import pandas as pd
import numpy  as np



import pickle
 
from pathlib import Path
import os



import sys
sys.path.append("D:/scRNA-seq_DE/DE_scRNAseq")


from  utilities import *
from FUNCTIONS_DE_scRNAseq  import *


pd.options.display.width = 180
pd.set_option('display.max_columns', 30)
 
#########################################################################################

pctl_list =  [ .1, .25,.5,.75,.9,.95, .96, .97, .98, .99,.995,.999 ]

#########################################################################################  

logfile_txt =  "randomized_MLE_cell_clusters_group_id B cells_41_randomizations.txt"

dict_MLE_results_list_pkl = "randomized_MLE_cell_clusters_group_id B cells_list_41_randomizations.pkl"
randomized_clusters_pkl = "randomized_cell_clusters_group_id B cells_41_randomizations.pkl"
# NLL_LR_stat_summary_pkl = "randomized_NLL_cell_clusters_group_id B cells.pkl"

column_data_select_pkl = "sce_column_data B cells.pkl"
counts_select_pkl = "sce_counts_B_cells.pkl"


data_path = Path ( r"D:/scRNA-seq_DE/Crowell_Kang18_8vs8" )



####  log output
logfile_dsn  =  data_path / logfile_txt
logfile = open ( logfile_dsn,'w')

# pickle outputs
dict_MLE_results_list_dsn = data_path / dict_MLE_results_list_pkl
randomized_clusters_dsn = data_path / randomized_clusters_pkl
# NLL_LR_stat_summary_dsn = data_path / NLL_LR_stat_summary_pkl


# pickle inputs
column_data_select_dsn  = data_path / column_data_select_pkl 
counts_select_dsn = data_path / counts_select_pkl

######################################################################################################################################

n_randomizations = 41


df_column_data_select = pd.read_pickle ( column_data_select_dsn )
df_counts_select = pd.read_pickle ( counts_select_dsn )

plog ( logfile, '\n\n df_column_data_select:\n\n' , df_column_data_select )
plog ( logfile, '\n\n df_counts_select:\n\n' , df_counts_select )


n_clusters = 1 + df_column_data_select['cluster_group_id'].max()
df_cell_clusters = df_column_data_select[['cluster_group_id']]
plog ( logfile, '\n\n df_cell_clusters:\n\n' , df_cell_clusters )


cluster_list = df_cell_clusters['cluster_group_id'].values.tolist()
df_randomized_clusters_list = []

for randomization in range ( n_randomizations ):
  print ( 'randomization ', randomization )
  np.random.shuffle( cluster_list )
  df_randomized_cl = pd.DataFrame ( index=df_cell_clusters.index, data=cluster_list, columns=[ randomization ] )  
  df_randomized_clusters_list.append ( df_randomized_cl )
df_randomized_clusters = pd.concat ( df_randomized_clusters_list, axis=1, sort=False )
plog ( logfile, '\n\n df_randomized_clusters: \n\n', df_randomized_clusters )
pdline ( logfile )
  


dict_MLE_results_list = []
for randomization in range ( n_randomizations ):
  print ( 'randomization ', randomization )
  plog ( logfile, '\n\n\n randomization: ', randomization )
  df_cell_clusters_parm = df_randomized_clusters[[randomization]].rename ( columns = {randomization: n_clusters} )
  result =  MLE_cell_cluster_models ( df_counts_select, df_cell_clusters_parm )
  dict_MLE_results = result[0]
  dict_MLE_results_list.append ( dict_MLE_results )
  df_NLL = result[1]   
  plog ( logfile, '\n\n df_NLL:\n\n' , df_NLL )  
    
  
  
  
f = open( dict_MLE_results_list_dsn, 'wb' )    
pickle.dump( dict_MLE_results_list, f)           
f.close()    

df_randomized_clusters.to_pickle ( randomized_clusters_dsn )

# df_NLL.to_pickle ( NLL_LR_stat_summary_dsn )



logfile.close()

#########################################################################################
#                                                                                       #    
#  end program  randomized_MLE_cell_clusters_group_id.py                                # 
#                                                                                       #   
#########################################################################################
#########################################################################################







 df_column_data_select:

                   ind group_id  cluster multiplets cluster_id sample_id  cluster_group_id  cluster_sample_id
AAACATTGCTCGAA-1  1256     ctrl        4    singlet    B cells  ctrl1256                 0                  6
AAACCGTGGGTGGA-1  1488     ctrl        4    singlet    B cells  ctrl1488                 0                  7
AAACGCACCCACCT-1  1256     ctrl        4    singlet    B cells  ctrl1256                 0                  6
AAACGCACGCTGTA-1  1015     ctrl        3    singlet    B cells  ctrl1015                 0                  1
AAACGCTGCTGACA-1  1015     ctrl        4    singlet    B cells  ctrl1015                 0                  1
...                ...      ...      ...        ...        ...       ...               ...                ...
TTTATCCTTCAGTG-1   101     stim        4    singlet    B cells   stim101                 1                  8
TTTCACGACCAACA-1  1016     stim        4    singlet    B cells  stim1016                 1                 10
TTTCACGAGCGAAG-1  1016     stim        4    singlet    B cells  stim1016                 1                 10
TTTGACTGGGTACT-1  1256     stim        4    singlet    B cells  stim1256                 1                 14
TTTGCATGCCTGTC-1  1256     stim        4    singlet    B cells  stim1256                 1                 14

[2735 rows x 8 columns]

 df_counts_select:

          AAACATTGCTCGAA-1  AAACCGTGGGTGGA-1  AAACGCACCCACCT-1  AAACGCACGCTGTA-1  AAACGCTGCTGACA-1  AAACGCTGTAGCGT-1  AAACGCTGTGCTAG-1  AAACTTGACATCAG-1  AAACTTGACTGAGT-1  \
NOC2L                    0                 0                 0                 0                 0                 0                 1                 1                 0   
HES4                     0                 0                 0                 0                 0                 0                 0                 0                 0   
ISG15                    0                 0                 0                 1                 0                 0                 1                 0                 0   
TNFRSF18                 0                 0                 0                 0                 1                 0                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...               ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 0                 0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0                 0                 0                 0   

          AAAGCCTGCTAGCA-1  AAAGCCTGTATTCC-1  AAAGGCCTGCTACA-1  AAAGGCCTTGACAC-1  AAAGTTTGAACCAC-1  AAAGTTTGACGGAG-1  ...  TTGGAGTGACAGCT-1  TTGGTACTCTAGTG-1  TTGGTACTTTGCTT-1  \
NOC2L                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
HES4                     0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
ISG15                    0                 0                 0                 0                 0                 0  ...                13                 8                12   
TNFRSF18                 0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...  ...               ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   

          TTGTACACAAAAGC-1  TTGTACACGACGAG-1  TTGTACACGGCATT-1  TTGTACACTACTCT-1  TTGTCATGGATGAA-1  TTTATCCTCTCTTA-1  TTTATCCTGCGAGA-11  TTTATCCTTCAGTG-1  TTTCACGACCAACA-1  \
NOC2L                    0                 0                 0                 0                 0                 0                  0                 0                 0   
HES4                     0                 3                 0                 0                 0                 0                  0                 0                 0   
ISG15                   15                 7                15                 9                 6                16                 10                 3                 9   
TNFRSF18                 0                 1                 0                 0                 0                 0                  0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                  0                 0                 0   
...                    ...               ...               ...               ...               ...               ...                ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 1                  0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0                  1                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                  0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                  0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0                  0                 0                 0   

          TTTCACGAGCGAAG-1  TTTGACTGGGTACT-1  TTTGCATGCCTGTC-1  
NOC2L                    0                 0                 0  
HES4                     0                 1                 0  
ISG15                   13                 3                16  
TNFRSF18                 0                 0                 0  
TNFRSF4                  0                 0                 0  
...                    ...               ...               ...  
PTTG1IP                  0                 0                 0  
ITGB2                    0                 0                 0  
FAM207A                  0                 0                 1  
DIP2A                    0                 0                 0  
PRMT2                    0                 0                 1  

[6563 rows x 2735 columns]

 df_cell_clusters:

                  cluster_group_id
AAACATTGCTCGAA-1                 0
AAACCGTGGGTGGA-1                 0
AAACGCACCCACCT-1                 0
AAACGCACGCTGTA-1                 0
AAACGCTGCTGACA-1                 0
...                            ...
TTTATCCTTCAGTG-1                 1
TTTCACGACCAACA-1                 1
TTTCACGAGCGAAG-1                 1
TTTGACTGGGTACT-1                 1
TTTGCATGCCTGTC-1                 1

[2735 rows x 1 columns]

 df_randomized_clusters: 

                  0   1   2   3   4   5   6   7   8   9   10  11  12  13  14  ...  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40
AAACATTGCTCGAA-1   1   0   0   1   0   1   1   0   0   0   0   0   1   0   0  ...   1   0   1   0   0   0   1   1   0   0   1   0   1   0   1
AAACCGTGGGTGGA-1   1   1   1   0   0   0   1   0   1   0   0   0   1   0   1  ...   1   0   0   0   1   1   0   1   1   1   0   1   1   0   0
AAACGCACCCACCT-1   0   0   1   1   0   0   1   0   0   0   0   1   0   0   1  ...   1   1   0   1   1   0   0   0   0   0   1   1   1   0   0
AAACGCACGCTGTA-1   1   0   0   0   0   0   1   0   1   0   0   0   1   0   1  ...   0   0   0   0   1   1   1   1   0   0   0   0   0   1   0
AAACGCTGCTGACA-1   0   1   1   1   1   0   1   0   0   1   0   1   1   1   1  ...   0   1   1   1   1   0   0   0   1   1   0   0   0   1   1
...               ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ...  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..  ..
TTTATCCTTCAGTG-1   1   1   1   1   1   0   0   1   0   0   0   1   1   0   0  ...   1   1   1   0   1   0   1   1   1   1   1   0   0   1   0
TTTCACGACCAACA-1   1   0   0   0   1   1   0   0   0   0   1   0   0   0   1  ...   0   1   0   1   1   0   0   1   0   0   0   0   1   1   1
TTTCACGAGCGAAG-1   1   0   1   0   0   1   1   0   0   1   1   0   1   1   1  ...   1   0   1   0   0   1   1   0   0   0   1   1   0   1   1
TTTGACTGGGTACT-1   1   0   1   0   0   1   1   0   1   0   0   1   1   0   1  ...   0   1   1   0   1   1   0   1   0   0   1   0   1   0   0
TTTGCATGCCTGTC-1   0   0   0   0   1   1   1   0   0   1   1   0   0   1   0  ...   0   0   1   1   0   1   1   1   1   0   0   0   0   1   1

[2735 rows x 41 columns]


--------------------------------------------------------------------------




 randomization: 0

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195308e+07  8.947595e+03
2735  1.856789e+07  6.779336e+06


 randomization: 1

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.194913e+07  1.684303e+04
2735  1.856789e+07  6.779336e+06


 randomization: 2

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195341e+07  8.280087e+03
2735  1.856789e+07  6.779336e+06


 randomization: 3

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195262e+07  9.872160e+03
2735  1.856789e+07  6.779336e+06


 randomization: 4

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195341e+07  8.291700e+03
2735  1.856789e+07  6.779336e+06


 randomization: 5

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.194779e+07  1.952596e+04
2735  1.856789e+07  6.779336e+06


 randomization: 6

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195315e+07  8.796839e+03
2735  1.856789e+07  6.779336e+06


 randomization: 7

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195129e+07  1.253086e+04
2735  1.856789e+07  6.779336e+06


 randomization: 8

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195168e+07  1.174105e+04
2735  1.856789e+07  6.779336e+06


 randomization: 9

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195112e+07  1.286110e+04
2735  1.856789e+07  6.779336e+06


 randomization: 10

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195254e+07  1.002566e+04
2735  1.856789e+07  6.779336e+06


 randomization: 11

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195011e+07  1.488003e+04
2735  1.856789e+07  6.779336e+06


 randomization: 12

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195350e+07  8.110135e+03
2735  1.856789e+07  6.779336e+06


 randomization: 13

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195347e+07  8.160050e+03
2735  1.856789e+07  6.779336e+06


 randomization: 14

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195344e+07  8.217035e+03
2735  1.856789e+07  6.779336e+06


 randomization: 15

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195310e+07  8.912740e+03
2735  1.856789e+07  6.779336e+06


 randomization: 16

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195274e+07  9.621843e+03
2735  1.856789e+07  6.779336e+06


 randomization: 17

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195353e+07  8.049234e+03
2735  1.856789e+07  6.779336e+06


 randomization: 18

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195295e+07  9.204624e+03
2735  1.856789e+07  6.779336e+06


 randomization: 19

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195304e+07  9.023683e+03
2735  1.856789e+07  6.779336e+06


 randomization: 20

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195327e+07  8.557857e+03
2735  1.856789e+07  6.779336e+06


 randomization: 21

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195353e+07  8.054548e+03
2735  1.856789e+07  6.779336e+06


 randomization: 22

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195242e+07  1.027105e+04
2735  1.856789e+07  6.779336e+06


 randomization: 23

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195282e+07  9.464976e+03
2735  1.856789e+07  6.779336e+06


 randomization: 24

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195158e+07  1.193827e+04
2735  1.856789e+07  6.779336e+06


 randomization: 25

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195118e+07  1.275030e+04
2735  1.856789e+07  6.779336e+06


 randomization: 26

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195318e+07  8.744076e+03
2735  1.856789e+07  6.779336e+06


 randomization: 27

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195099e+07  1.311856e+04
2735  1.856789e+07  6.779336e+06


 randomization: 28

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195306e+07  8.988717e+03
2735  1.856789e+07  6.779336e+06


 randomization: 29

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195255e+07  1.001067e+04
2735  1.856789e+07  6.779336e+06


 randomization: 30

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195315e+07  8.802636e+03
2735  1.856789e+07  6.779336e+06


 randomization: 31

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195330e+07  8.498049e+03
2735  1.856789e+07  6.779336e+06


 randomization: 32

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195182e+07  1.146226e+04
2735  1.856789e+07  6.779336e+06


 randomization: 33

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195267e+07  9.770558e+03
2735  1.856789e+07  6.779336e+06


 randomization: 34

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195316e+07  8.780479e+03
2735  1.856789e+07  6.779336e+06


 randomization: 35

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195259e+07  9.924395e+03
2735  1.856789e+07  6.779336e+06


 randomization: 36

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195328e+07  8.543663e+03
2735  1.856789e+07  6.779336e+06


 randomization: 37

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195229e+07  1.052817e+04
2735  1.856789e+07  6.779336e+06


 randomization: 38

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.194440e+07  2.631603e+04
2735  1.856789e+07  6.779336e+06


 randomization: 39

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.195322e+07  8.657016e+03
2735  1.856789e+07  6.779336e+06


 randomization: 40

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.194841e+07  1.827786e+04
2735  1.856789e+07  6.779336e+06