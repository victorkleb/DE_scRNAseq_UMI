

#########################################################################################
#########################################################################################
#                                                                                       #    
#  start program  MLE_cell_clusters_group_id.py                                         # 
#                                                                                       #   
#########################################################################################
#
#  invoke FUNCTION   MLE_cell_cluster_models   
#
#########################################################################################

import pandas as pd
import numpy  as np



import pickle
 
from pathlib import Path
import os



import sys
sys.path.append("D:/scRNA-seq_DE/DE_scRNAseq")


from  utilities import *
from FUNCTIONS_DE_scRNAseq  import *


pd.options.display.width = 180
pd.set_option('display.max_columns', 30)
 
#########################################################################################

pctl_list =  [ .1, .25,.5,.75,.9,.95, .96, .97, .98, .99,.995,.999 ]

#########################################################################################  

logfile_txt =  "MLE_cell_clusters_group_id B cells.txt"

dict_MLE_results_pkl = "MLE_cell_clusters_group_id B cells.pkl"
# NLL_LR_stat_summary_pkl = "NLL_cell_clusters_group_id B cells.pkl"

column_data_select_pkl = "sce_column_data B cells.pkl"
counts_select_pkl = "sce_counts_B_cells.pkl"


data_path = Path ( r"D:/scRNA-seq_DE/Crowell_Kang18_8vs8" )



####  log output
logfile_dsn  =  data_path / logfile_txt
logfile = open ( logfile_dsn,'w')

# pickle outputs
dict_MLE_results_dsn = data_path / dict_MLE_results_pkl
# NLL_LR_stat_summary_dsn = data_path / NLL_LR_stat_summary_pkl


# pickle inputs
column_data_select_dsn  = data_path / column_data_select_pkl 
counts_select_dsn = data_path / counts_select_pkl

######################################################################################################################################

df_column_data_select = pd.read_pickle ( column_data_select_dsn )
df_counts_select = pd.read_pickle ( counts_select_dsn )

plog ( logfile, '\n\n df_column_data_select:\n\n' , df_column_data_select )
plog ( logfile, '\n\n df_counts_select:\n\n' , df_counts_select )


n_clusters = 1 + df_column_data_select['cluster_group_id'].max()
df_cell_clusters = df_column_data_select[['cluster_group_id']].rename ( columns = {'cluster_group_id': n_clusters} )
plog ( logfile, '\n\n df_cell_clusters:\n\n' , df_cell_clusters )



result =  MLE_cell_cluster_models ( df_counts_select, df_cell_clusters )
  
dict_MLE_results = result[0]
df_NLL = result[1] 
  
plog ( logfile, '\n\n df_NLL:\n\n' , df_NLL )  
  
  
  
  
f = open( dict_MLE_results_dsn, 'wb' )    
pickle.dump( dict_MLE_results, f)           
f.close()    

# df_NLL.to_pickle ( NLL_LR_stat_summary_dsn )



logfile.close()

#########################################################################################
#                                                                                       #    
#  end program  MLE_cell_clusters_group_id.py                                           # 
#                                                                                       #   
#########################################################################################
#########################################################################################





 df_column_data_select:

                   ind group_id  cluster multiplets cluster_id sample_id  cluster_group_id  cluster_sample_id
AAACATTGCTCGAA-1  1256     ctrl        4    singlet    B cells  ctrl1256                 0                  6
AAACCGTGGGTGGA-1  1488     ctrl        4    singlet    B cells  ctrl1488                 0                  7
AAACGCACCCACCT-1  1256     ctrl        4    singlet    B cells  ctrl1256                 0                  6
AAACGCACGCTGTA-1  1015     ctrl        3    singlet    B cells  ctrl1015                 0                  1
AAACGCTGCTGACA-1  1015     ctrl        4    singlet    B cells  ctrl1015                 0                  1
...                ...      ...      ...        ...        ...       ...               ...                ...
TTTATCCTTCAGTG-1   101     stim        4    singlet    B cells   stim101                 1                  8
TTTCACGACCAACA-1  1016     stim        4    singlet    B cells  stim1016                 1                 10
TTTCACGAGCGAAG-1  1016     stim        4    singlet    B cells  stim1016                 1                 10
TTTGACTGGGTACT-1  1256     stim        4    singlet    B cells  stim1256                 1                 14
TTTGCATGCCTGTC-1  1256     stim        4    singlet    B cells  stim1256                 1                 14

[2735 rows x 8 columns]

 df_counts_select:

          AAACATTGCTCGAA-1  AAACCGTGGGTGGA-1  AAACGCACCCACCT-1  AAACGCACGCTGTA-1  AAACGCTGCTGACA-1  AAACGCTGTAGCGT-1  AAACGCTGTGCTAG-1  AAACTTGACATCAG-1  AAACTTGACTGAGT-1  \
NOC2L                    0                 0                 0                 0                 0                 0                 1                 1                 0   
HES4                     0                 0                 0                 0                 0                 0                 0                 0                 0   
ISG15                    0                 0                 0                 1                 0                 0                 1                 0                 0   
TNFRSF18                 0                 0                 0                 0                 1                 0                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...               ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 0                 0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0                 0                 0                 0   

          AAAGCCTGCTAGCA-1  AAAGCCTGTATTCC-1  AAAGGCCTGCTACA-1  AAAGGCCTTGACAC-1  AAAGTTTGAACCAC-1  AAAGTTTGACGGAG-1  ...  TTGGAGTGACAGCT-1  TTGGTACTCTAGTG-1  TTGGTACTTTGCTT-1  \
NOC2L                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
HES4                     0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
ISG15                    0                 0                 0                 0                 0                 0  ...                13                 8                12   
TNFRSF18                 0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...  ...               ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   

          TTGTACACAAAAGC-1  TTGTACACGACGAG-1  TTGTACACGGCATT-1  TTGTACACTACTCT-1  TTGTCATGGATGAA-1  TTTATCCTCTCTTA-1  TTTATCCTGCGAGA-11  TTTATCCTTCAGTG-1  TTTCACGACCAACA-1  \
NOC2L                    0                 0                 0                 0                 0                 0                  0                 0                 0   
HES4                     0                 3                 0                 0                 0                 0                  0                 0                 0   
ISG15                   15                 7                15                 9                 6                16                 10                 3                 9   
TNFRSF18                 0                 1                 0                 0                 0                 0                  0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                  0                 0                 0   
...                    ...               ...               ...               ...               ...               ...                ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 1                  0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0                  1                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                  0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                  0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0                  0                 0                 0   

          TTTCACGAGCGAAG-1  TTTGACTGGGTACT-1  TTTGCATGCCTGTC-1  
NOC2L                    0                 0                 0  
HES4                     0                 1                 0  
ISG15                   13                 3                16  
TNFRSF18                 0                 0                 0  
TNFRSF4                  0                 0                 0  
...                    ...               ...               ...  
PTTG1IP                  0                 0                 0  
ITGB2                    0                 0                 0  
FAM207A                  0                 0                 1  
DIP2A                    0                 0                 0  
PRMT2                    0                 0                 1  

[6563 rows x 2735 columns]

 df_cell_clusters:

                  2
AAACATTGCTCGAA-1  0
AAACCGTGGGTGGA-1  0
AAACGCACCCACCT-1  0
AAACGCACGCTGTA-1  0
AAACGCTGCTGACA-1  0
...              ..
TTTATCCTTCAGTG-1  1
TTTCACGACCAACA-1  1
TTTCACGAGCGAAG-1  1
TTTGACTGGGTACT-1  1
TTTGCATGCCTGTC-1  1

[2735 rows x 1 columns]

 df_NLL:

               NLL  LR statistic
1     2.195755e+07           NaN
2     2.185171e+07  2.116903e+05
2735  1.856789e+07  6.779336e+06