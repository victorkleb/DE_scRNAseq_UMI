################################################################################################################################ 
##                                                                                                                            ##
##  start program: extract_cluster_data.py                                                                                    ##
##                                                                                                                            ## 
################################################################################################################################


import pandas as pd
import numpy  as np



from scipy.stats import chi2_contingency
 
from pathlib import Path
import os


import sys
sys.path.append("D:/scRNA-seq_DE/DE_scRNAseq")


from  utilities import *
from FUNCTIONS_DE_scRNAseq  import *




pd.options.display.width = 180
pd.set_option('display.max_columns', 30)
 
#########################################################################################

def pv_table (  dsin0, col1,   col2 ):
  # print( 'col1: ', col1, '    col2: ', col2 )
  dsin = dsin0.copy()
  dsin ['count'] = 1
  pt = pd.pivot_table( dsin, values='count',  index=[ col1 ], columns=[ col2 ], aggfunc=np.sum, margins=True )
  ptfna = pt.fillna(0)
  pti = ptfna.astype(int)
  print ( '\n\n\n ',pti ,  file = logfile )
  g, p, dof, expctd = chi2_contingency( pti, lambda_="log-likelihood")
  print ( '\ng-statistic: ', format(g, '.2f') , '     p-value: ', format(p, '.6f'), '\n', file = logfile )
  
  return pti




pctl_list =  [ .1, .25,.5,.75,.9,.95, .96, .97, .98, .99,.995,.999 ]

#########################################################################################  

logfile_txt = "extract_cluster_data B cells.txt"

column_data_select_pkl = "sce_column_data B cells.pkl"
counts_select_pkl = "sce_counts_B_cells.pkl"

counts_csv = "sce_counts.csv"
column_data_csv = "sce_column_data.csv"


data_path = Path ( r"D:/scRNA-seq_DE/Crowell_Kang18_8vs8" )
 
 
####  log output
logfile_dsn  =  data_path /  logfile_txt
logfile = open ( logfile_dsn,'w')

#### pickle outputs 
column_data_select_dsn  = data_path / column_data_select_pkl 
counts_select_dsn = data_path / counts_select_pkl


# input
counts_dsn = data_path / counts_csv
column_data_dsn  = data_path / column_data_csv


######################################################################################################################################

df_column_data = pd.read_csv ( column_data_dsn, index_col=0 ).drop ( columns=['cell','sizeFactor', 'factor_ind'] ) .rename ( columns={'stim':'group_id'} )
plog ( logfile, '\n\n df_column_data:\n\n' , df_column_data )
plog ( logfile, '\n\n df_column_data - columns: \n\n', df_column_data.columns.values.tolist() ) 
plog ( logfile, '\n\n unique values of cluster_id: \n',  df_column_data['cluster_id'].unique().tolist() ) 


df_counts = pd.read_csv ( counts_dsn,  index_col = 0  )
plog ( logfile, '\n\n df_counts:\n\n' , df_counts )
pdline( logfile )



plog ( logfile, '\n\n cross-tab numeric cluster vs alpha cluster_id: ' )
xtab = pv_table ( df_column_data,  'cluster', 'cluster_id' )


cluster_select =  'B cells'
df_column_data_select = df_column_data.loc [ df_column_data['cluster_id'] == cluster_select ]
plog ( logfile, '\n\n df_column_data_select:\n\n' , df_column_data_select )

list_group_id_values = df_column_data_select['group_id'].unique().tolist()
list_group_id_values.sort()

list_sample_id_values = df_column_data_select['sample_id'].unique().tolist()
list_sample_id_values.sort()

dict_rn_group_id = dict ( zip (  list_group_id_values, list ( range ( 1 + len ( list_group_id_values ) ) ) ) ) 
dict_rn_sample_id = dict ( zip (  list_sample_id_values, list ( range ( 1 + len ( list_sample_id_values ) ) ) ) ) 

df_column_data_select['cluster_group_id'] = df_column_data_select['group_id'].map ( dict_rn_group_id )
df_column_data_select['cluster_sample_id'] = df_column_data_select['sample_id'].map ( dict_rn_sample_id )

plog ( logfile, '\n\n df_column_data_select:\n\n' , df_column_data_select )



df_counts_select0 = df_counts [ df_column_data_select.index.values.tolist() ]
plog ( logfile, '\n\n df_counts_select0:\n\n' , df_counts_select0 )

ser_counts_select0_number_GT_0 = ( df_counts_select0 > 0 ).sum ( axis=1 )
plog ( logfile, '\n\n distribution of ser_counts_select0_number_GT_0:\n\n' , ser_counts_select0_number_GT_0.describe ( percentiles = pctl_list ) )

df_counts_select = df_counts_select0.loc [ ser_counts_select0_number_GT_0 >= 10 ]
plog ( logfile, '\n\n df_counts_select:\n\n' , df_counts_select )

df_column_data_select.to_pickle ( column_data_select_dsn )
df_counts_select.to_pickle ( counts_select_dsn )


logfile.close()
 
################################################################################################################################ 
##                                                                                                                            ##
##  ends program: extract_cluster_data.py                                                                                     ##
##                                                                                                                            ## 
################################################################################################################################ 



 df_column_data:

                   ind group_id  cluster multiplets       cluster_id sample_id
AAACATACAATGCC-1   107     ctrl        5    doublet      CD4 T cells   ctrl107
AAACATACATTTCC-1  1016     ctrl        9    singlet  CD14+ Monocytes  ctrl1016
AAACATACCAGAAA-1  1256     ctrl        9    singlet  CD14+ Monocytes  ctrl1256
AAACATACCAGCTA-1  1256     ctrl        9    doublet  CD14+ Monocytes  ctrl1256
AAACATACCATGCA-1  1488     ctrl        3    singlet      CD4 T cells  ctrl1488
...                ...      ...      ...        ...              ...       ...
TTTGCATGCTAAGC-1   107     stim        6    singlet      CD4 T cells   stim107
TTTGCATGGGACGA-1  1488     stim        6    singlet      CD4 T cells  stim1488
TTTGCATGGTGAGG-1  1488     stim        6       ambs      CD4 T cells  stim1488
TTTGCATGGTTTGG-1  1244     stim        6       ambs      CD4 T cells  stim1244
TTTGCATGTCTTAC-1  1016     stim        5    singlet      CD4 T cells  stim1016

[26820 rows x 6 columns]

 df_column_data - columns: 

['ind', 'group_id', 'cluster', 'multiplets', 'cluster_id', 'sample_id']

 unique values of cluster_id: 
['CD4 T cells', 'CD14+ Monocytes', 'NK cells', 'CD8 T cells', 'B cells', 'Megakaryocytes', 'FCGR3A+ Monocytes', 'Dendritic cells']

 df_counts:

          AAACATACAATGCC-1  AAACATACATTTCC-1  AAACATACCAGAAA-1  AAACATACCAGCTA-1  AAACATACCATGCA-1  AAACATACCTCGCT-1  AAACATACGATGAA-1  AAACATACGCCAAT-1  AAACATACGCTTCC-1  \
NOC2L                    0                 0                 0                 0                 0                 0                 0                 0                 0   
HES4                     0                 0                 0                 0                 0                 0                 0                 0                 0   
ISG15                    0                 0                 0                 0                 0                 1                 0                 0                 0   
TNFRSF18                 0                 0                 0                 0                 0                 0                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                 1                 0                 0   
...                    ...               ...               ...               ...               ...               ...               ...               ...               ...   
ITGB2                    0                 1                 1                 0                 0                 0                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                 0                 0                 0   
S100B                    0                 0                 0                 0                 0                 0                 0                 0                 0   
PRMT2                    0                 0                 0                 1                 0                 0                 0                 0                 0   

          AAACATACGGCATT-1  AAACATACGTGTAC-1  AAACATACGTTGTG-1  AAACATACTGCGTA-1  AAACATACTGCTGA-1  AAACATACTGGTCA-1  ...  TTTGACTGGAGGAC-1  TTTGACTGGCGAAG-1  TTTGACTGGGTACT-1  \
NOC2L                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
HES4                     0                 0                 0                 0                 0                 0  ...                 0                 0                 1   
ISG15                    3                 0                 0                 1                 0                 0  ...                17                10                 3   
TNFRSF18                 0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 1  ...                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...  ...               ...               ...               ...   
ITGB2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
S100B                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
PRMT2                    0                 0                 0                 3                 0                 0  ...                 0                 0                 0   

          TTTGCATGACGTAC-1  TTTGCATGAGGTTC-1  TTTGCATGAGTGTC-1  TTTGCATGCATGAC-1  TTTGCATGCCTGAA-1  TTTGCATGCCTGTC-1  TTTGCATGCCTTAT-1  TTTGCATGCTAAGC-1  TTTGCATGGGACGA-1  \
NOC2L                    0                 0                 0                 0                 0                 0                 0                 0                 0   
HES4                     0                 0                 0                 1                 0                 0                 0                 0                 0   
ISG15                    7                29                 1                72                 6                16                93                 4                10   
TNFRSF18                 0                 0                 0                 0                 0                 0                 0                 0                 0   
TNFRSF4                  1                 0                 0                 0                 0                 0                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...               ...               ...               ...   
ITGB2                    0                 0                 0                 0                 0                 0                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 1                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                 0                 0                 0   
S100B                    0                 0                 0                 0                 0                 0                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 1                 1                 0                 0   

          TTTGCATGGTGAGG-1  TTTGCATGGTTTGG-1  TTTGCATGTCTTAC-1  
NOC2L                    0                 0                 0  
HES4                     0                 0                 0  
ISG15                    4                 8                 3  
TNFRSF18                 0                 0                 0  
TNFRSF4                  0                 0                 5  
...                    ...               ...               ...  
ITGB2                    0                 0                 0  
FAM207A                  0                 0                 0  
DIP2A                    0                 0                 0  
S100B                    0                 0                 0  
PRMT2                    0                 0                 0  

[7118 rows x 26820 columns]


--------------------------------------------------------------------------



 cross-tab numeric cluster vs alpha cluster_id: 


  cluster_id  B cells  CD14+ Monocytes  CD4 T cells  CD8 T cells  Dendritic cells  FCGR3A+ Monocytes  Megakaryocytes  NK cells    All
cluster                                                                                                                            
1                 0                3            0            0                0                766               2         0    771
2                 0                1            0            1               25                  0              46         0     73
3                30                5          917           42                4                  6              27        22   1053
4              2607               16           54           33               50                 29              33        10   2832
5                58               24         5294          188                0                  9              36        34   5643
6                33               36         4806           94                4                 14              48        39   5074
7                 0                0            0           80                0                  1               6      1805   1892
8                 0             2601            4            0               69                319               9         8   3010
9                 1             2824            4            0               67                337              22         5   3260
10                6                7          692         2119                1                  8              18       361   3212
All            2735             5517        11771         2557              220               1489             247      2284  26820

g-statistic:  62340.99      p-value:  0.000000 



 df_column_data_select:

                   ind group_id  cluster multiplets cluster_id sample_id
AAACATTGCTCGAA-1  1256     ctrl        4    singlet    B cells  ctrl1256
AAACCGTGGGTGGA-1  1488     ctrl        4    singlet    B cells  ctrl1488
AAACGCACCCACCT-1  1256     ctrl        4    singlet    B cells  ctrl1256
AAACGCACGCTGTA-1  1015     ctrl        3    singlet    B cells  ctrl1015
AAACGCTGCTGACA-1  1015     ctrl        4    singlet    B cells  ctrl1015
...                ...      ...      ...        ...        ...       ...
TTTATCCTTCAGTG-1   101     stim        4    singlet    B cells   stim101
TTTCACGACCAACA-1  1016     stim        4    singlet    B cells  stim1016
TTTCACGAGCGAAG-1  1016     stim        4    singlet    B cells  stim1016
TTTGACTGGGTACT-1  1256     stim        4    singlet    B cells  stim1256
TTTGCATGCCTGTC-1  1256     stim        4    singlet    B cells  stim1256

[2735 rows x 6 columns]

 df_column_data_select:

                   ind group_id  cluster multiplets cluster_id sample_id  cluster_group_id  cluster_sample_id
AAACATTGCTCGAA-1  1256     ctrl        4    singlet    B cells  ctrl1256                 0                  6
AAACCGTGGGTGGA-1  1488     ctrl        4    singlet    B cells  ctrl1488                 0                  7
AAACGCACCCACCT-1  1256     ctrl        4    singlet    B cells  ctrl1256                 0                  6
AAACGCACGCTGTA-1  1015     ctrl        3    singlet    B cells  ctrl1015                 0                  1
AAACGCTGCTGACA-1  1015     ctrl        4    singlet    B cells  ctrl1015                 0                  1
...                ...      ...      ...        ...        ...       ...               ...                ...
TTTATCCTTCAGTG-1   101     stim        4    singlet    B cells   stim101                 1                  8
TTTCACGACCAACA-1  1016     stim        4    singlet    B cells  stim1016                 1                 10
TTTCACGAGCGAAG-1  1016     stim        4    singlet    B cells  stim1016                 1                 10
TTTGACTGGGTACT-1  1256     stim        4    singlet    B cells  stim1256                 1                 14
TTTGCATGCCTGTC-1  1256     stim        4    singlet    B cells  stim1256                 1                 14

[2735 rows x 8 columns]

 df_counts_select0:

          AAACATTGCTCGAA-1  AAACCGTGGGTGGA-1  AAACGCACCCACCT-1  AAACGCACGCTGTA-1  AAACGCTGCTGACA-1  AAACGCTGTAGCGT-1  AAACGCTGTGCTAG-1  AAACTTGACATCAG-1  AAACTTGACTGAGT-1  \
NOC2L                    0                 0                 0                 0                 0                 0                 1                 1                 0   
HES4                     0                 0                 0                 0                 0                 0                 0                 0                 0   
ISG15                    0                 0                 0                 1                 0                 0                 1                 0                 0   
TNFRSF18                 0                 0                 0                 0                 1                 0                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...               ...               ...               ...   
ITGB2                    0                 0                 0                 0                 0                 0                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                 0                 0                 0   
S100B                    0                 0                 0                 0                 0                 0                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0                 0                 0                 0   

          AAAGCCTGCTAGCA-1  AAAGCCTGTATTCC-1  AAAGGCCTGCTACA-1  AAAGGCCTTGACAC-1  AAAGTTTGAACCAC-1  AAAGTTTGACGGAG-1  ...  TTGGAGTGACAGCT-1  TTGGTACTCTAGTG-1  TTGGTACTTTGCTT-1  \
NOC2L                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
HES4                     0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
ISG15                    0                 0                 0                 0                 0                 0  ...                13                 8                12   
TNFRSF18                 0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...  ...               ...               ...               ...   
ITGB2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
S100B                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   

          TTGTACACAAAAGC-1  TTGTACACGACGAG-1  TTGTACACGGCATT-1  TTGTACACTACTCT-1  TTGTCATGGATGAA-1  TTTATCCTCTCTTA-1  TTTATCCTGCGAGA-11  TTTATCCTTCAGTG-1  TTTCACGACCAACA-1  \
NOC2L                    0                 0                 0                 0                 0                 0                  0                 0                 0   
HES4                     0                 3                 0                 0                 0                 0                  0                 0                 0   
ISG15                   15                 7                15                 9                 6                16                 10                 3                 9   
TNFRSF18                 0                 1                 0                 0                 0                 0                  0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                  0                 0                 0   
...                    ...               ...               ...               ...               ...               ...                ...               ...               ...   
ITGB2                    0                 0                 0                 0                 0                 0                  1                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                  0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                  0                 0                 0   
S100B                    0                 0                 0                 0                 0                 0                  0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0                  0                 0                 0   

          TTTCACGAGCGAAG-1  TTTGACTGGGTACT-1  TTTGCATGCCTGTC-1  
NOC2L                    0                 0                 0  
HES4                     0                 1                 0  
ISG15                   13                 3                16  
TNFRSF18                 0                 0                 0  
TNFRSF4                  0                 0                 0  
...                    ...               ...               ...  
ITGB2                    0                 0                 0  
FAM207A                  0                 0                 1  
DIP2A                    0                 0                 0  
S100B                    0                 0                 0  
PRMT2                    0                 0                 1  

[7118 rows x 2735 columns]

 distribution of ser_counts_select0_number_GT_0:

count    7118.000000
mean      201.074740
std       366.850597
min         0.000000
10%        14.000000
25%        38.000000
50%        82.000000
75%       198.750000
90%       459.300000
95%       793.150000
96%       895.000000
97%      1051.980000
98%      1457.960000
99%      2349.470000
99.5%    2653.830000
99.9%    2729.000000
max      2735.000000
dtype: float64

 df_counts_select:

          AAACATTGCTCGAA-1  AAACCGTGGGTGGA-1  AAACGCACCCACCT-1  AAACGCACGCTGTA-1  AAACGCTGCTGACA-1  AAACGCTGTAGCGT-1  AAACGCTGTGCTAG-1  AAACTTGACATCAG-1  AAACTTGACTGAGT-1  \
NOC2L                    0                 0                 0                 0                 0                 0                 1                 1                 0   
HES4                     0                 0                 0                 0                 0                 0                 0                 0                 0   
ISG15                    0                 0                 0                 1                 0                 0                 1                 0                 0   
TNFRSF18                 0                 0                 0                 0                 1                 0                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...               ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 0                 0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0                 0                 0                 0   

          AAAGCCTGCTAGCA-1  AAAGCCTGTATTCC-1  AAAGGCCTGCTACA-1  AAAGGCCTTGACAC-1  AAAGTTTGAACCAC-1  AAAGTTTGACGGAG-1  ...  TTGGAGTGACAGCT-1  TTGGTACTCTAGTG-1  TTGGTACTTTGCTT-1  \
NOC2L                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
HES4                     0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
ISG15                    0                 0                 0                 0                 0                 0  ...                13                 8                12   
TNFRSF18                 0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
...                    ...               ...               ...               ...               ...               ...  ...               ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0  ...                 0                 0                 0   

          TTGTACACAAAAGC-1  TTGTACACGACGAG-1  TTGTACACGGCATT-1  TTGTACACTACTCT-1  TTGTCATGGATGAA-1  TTTATCCTCTCTTA-1  TTTATCCTGCGAGA-11  TTTATCCTTCAGTG-1  TTTCACGACCAACA-1  \
NOC2L                    0                 0                 0                 0                 0                 0                  0                 0                 0   
HES4                     0                 3                 0                 0                 0                 0                  0                 0                 0   
ISG15                   15                 7                15                 9                 6                16                 10                 3                 9   
TNFRSF18                 0                 1                 0                 0                 0                 0                  0                 0                 0   
TNFRSF4                  0                 0                 0                 0                 0                 0                  0                 0                 0   
...                    ...               ...               ...               ...               ...               ...                ...               ...               ...   
PTTG1IP                  0                 0                 0                 0                 0                 1                  0                 0                 0   
ITGB2                    0                 0                 0                 0                 0                 0                  1                 0                 0   
FAM207A                  0                 0                 0                 0                 0                 0                  0                 0                 0   
DIP2A                    0                 0                 0                 0                 0                 0                  0                 0                 0   
PRMT2                    0                 0                 0                 0                 0                 0                  0                 0                 0   

          TTTCACGAGCGAAG-1  TTTGACTGGGTACT-1  TTTGCATGCCTGTC-1  
NOC2L                    0                 0                 0  
HES4                     0                 1                 0  
ISG15                   13                 3                16  
TNFRSF18                 0                 0                 0  
TNFRSF4                  0                 0                 0  
...                    ...               ...               ...  
PTTG1IP                  0                 0                 0  
ITGB2                    0                 0                 0  
FAM207A                  0                 0                 1  
DIP2A                    0                 0                 0  
PRMT2                    0                 0                 1  

[6563 rows x 2735 columns]